//
//  NewTroopsView.cpp
//  IF
//
//  Created by xxrdsg on 15-8-31.
//
//

#include "NewTroopsView.h"
#include "ArmyController.h"
#include "WorldController.h"
#include "MarchFormationView.h"
#include "PopupViewController.h"
#include "FunBuildController.h"
#include "soldierIconCell.hpp"
#include "GuideController.h"
#include "SoldierInfoView.h"
#include "WorldController.h"
#include "WorldCommand.h"
#include "QueueController.h"
#include "VipUtil.h"

static string guideKey = "";
static const char* troops_roman[30] =  {"I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX", "XXI","XXII","XXIII","XXIV","XXV","XXVI","XXVII","XXVIII","XXIX","XXX"};

NewTroopsView* NewTroopsView::create()
{
    auto ret = new NewTroopsView();
    if (ret && ret->init()) {
        ret->autorelease();
    } else {
        CC_SAFE_DELETE(ret);
    }
    return ret;
}

bool NewTroopsView::init()
{
    if (!PopupBaseView::init()) {
        return false;
    }
    guideKey = "";
    setIsHDPanel(true);
    CCLoadSprite::doResourceByCommonIndex(7, true);
    CCLoadSprite::doResourceByCommonIndex(200, true);
    CCLoadSprite::doResourceByCommonIndex(201, true);
    CCLoadSprite::doResourceByCommonIndex(202, true);
    CCLoadSprite::doResourceByCommonIndex(203, true);
    CCLoadSprite::doResourceByCommonIndex(204, true);
    CCLoadSprite::doResourceByCommonIndex(504, true);
    setCleanFunction([](){
        CCLoadSprite::doResourceByCommonIndex(7, false);
        CCLoadSprite::doResourceByCommonIndex(200, false);
        CCLoadSprite::doResourceByCommonIndex(201, false);
        CCLoadSprite::doResourceByCommonIndex(202, false);
        CCLoadSprite::doResourceByCommonIndex(203, false);
        CCLoadSprite::doResourceByCommonIndex(204, false);
        CCLoadSprite::doResourceByCommonIndex(504, false);
    });
    auto frame = CCLoadSprite::loadResource("technology_09.png");
    auto tBatchnode = CCSpriteBatchNode::createWithTexture(frame->getTexture());
    auto size = CCDirector::sharedDirector()->getWinSize();
    int curH = 0;
    while (curH < size.height) {
        auto spr = CCLoadSprite::createSprite("technology_09.png");
        spr->setAnchorPoint(CCPointZero);
        spr->setPosition(ccp(0, curH));
        tBatchnode->addChild(spr);
        curH += spr->getContentSize().height;
    }
    if (CCCommonUtils::isIosAndroidPad())
    {
        tBatchnode->setScaleX(1536.0 / 640);
    }
    this->addChild(tBatchnode);
    auto tmpCCB = CCBLoadFile("NewTroopsView",this,this);
    this->setContentSize(tmpCCB->getContentSize());
    int add = size.height - tmpCCB->getContentSize().height;
    tBatchnode->setPositionY(tBatchnode->getPositionY() - add);
    m_listNode->setPositionY(m_listNode->getPositionY() - add);
    m_listNode->setContentSize(CCSize(m_listNode->getContentSize().width, m_listNode->getContentSize().height + add));
    m_scrollView = CCScrollView::create(m_listNode->getContentSize());
    m_scrollView->setDirection(kCCScrollViewDirectionVertical);
    m_scrollView->setContentSize(m_listNode->getContentSize());
    m_scrollView->setAnchorPoint(ccp(0, 0));
    m_scrollView->setPosition(ccp(0, 0));
    m_scrollView->setDelegate(this);
    m_listNode->addChild(m_scrollView);
    m_mainNode = CCNode::create();
    m_scrollView->addChild(m_mainNode);
    
    if (WorldController::getInstance()->getCurrentMarchCount() > 0)
    {
        auto & marchInfo = WorldController::getInstance()->m_marchInfo;
        for (auto &march:marchInfo) {
            if (march.second.ownerType == PlayerSelf && march.second.uuid != "") {
                auto cmd = new WorldMarchDetailUpdateCommand(march.second.uuid);
                cmd->sendAndRelease();
            }
        }
    }
    
    refreshView(nullptr);
    auto& build = FunBuildController::getInstance()->getFunbuildById(FUN_BUILD_MAIN_CITY_ID);
    if (build.level <= 6 && CCCommonUtils::isTestPlatformAndServer("Guide_TrainField")) {
        GuideController::share()->checkSubGuide("3220100");
    }
    return true;
}

void NewTroopsView::refreshView(cocos2d::CCObject * obj)
{
    float dy0 = 0;
    float cury0 = m_scrollView->getContentSize().height;
    if (m_scrollView->getContentSize().height > m_listNode->getContentSize().height) {
        dy0 = m_scrollView->getContentOffset().y;
    }
    bool hasMarch = false;
    
    float dy1 = m_scrollView->getContentOffset().y;
    float minDy1 = m_scrollView->minContainerOffset().y;
    
    float troops_cell_width = 158;
    float troops_cell_height = 280;
    int cellCnt = 4;
    
    int marchCellCnt = 6;
    float march_cell_width = 104;
    float march_cell_height = 170;
    if (CCCommonUtils::isIosAndroidPad())
    {
        troops_cell_width = 1536 / 5.0;
        troops_cell_height = 552;
        cellCnt = 5;
        
        marchCellCnt = 8;
        march_cell_width = 186;
        march_cell_height = 340;
    }
    m_mainNode->removeAllChildrenWithCleanup(true);
    int cury = 0;
    
    //俩按钮
    //判断是否有编队功能按钮:15本两个,SVIP根据等级取值
    int formationCount = 0;
    if (FunBuildController::getInstance()->getMainCityLv() >= 15) {
        formationCount += 2;
    }
    auto &playerInfo = GlobalData::shared()->playerInfo;
    int svipLv = playerInfo.SVIPLevel;
    if(VipUtil::isSVIP() && svipLv > 0 && playerInfo.vipEndTime > GlobalData::shared()->getWorldTime()) {
        int itemID = 7010+svipLv-1;
        int value = atoi(CCCommonUtils::getPropById(CC_ITOA(itemID), "troop").c_str());
        if (value > 0) {
            formationCount += value;
        }
    }
    if (formationCount > 0 && GlobalData::shared()->march_formation_switch == 2 && ArmyController::getInstance()->getTotalArmyMan() > 0) {
        auto cell = NewTroopsBtn::create();
        cell->setPosition(0, cury);
        m_mainNode->addChild(cell);
        if (CCCommonUtils::isIosAndroidPad())
        {
            cury -= 126;
        } else {
            cury -= 55;
        }
    }
    
    //army title
    auto armyTitle = NewTroopsArmyTitle::create();
    armyTitle->setPosition(0, cury);
    m_mainNode->addChild(armyTitle);
    m_guideNode1 = CCNode::create();
    m_guideNode1->setAnchorPoint(ccp(0, 1));
    m_guideNode1->setPosition(0, cury);
    if (CCCommonUtils::isIosAndroidPad())
    {
        cury -= 289;
        m_guideNode1->setContentSize(Size(1536, 224));
    } else {
        cury -= 162;
        m_guideNode1->setContentSize(Size(640, 108));
    }
    m_mainNode->addChild(m_guideNode1);
    
    //army cells map
    map< int, vector<string> > armyMap;
    int id = 0;
    int type = 0;
    for (auto it = GlobalData::shared()->armyList.rbegin(); it != GlobalData::shared()->armyList.rend(); ++it)
    {
        id = atoi((it->first).c_str());
        type = id / 100;
        if (it->second.free > 0) {
            switch (type) {
                case 1070:
                    armyMap[1].push_back(it->first);
                    break;
                case 1071:
                    armyMap[2].push_back(it->first);
                    break;
                case 1072:
                    armyMap[3].push_back(it->first);
                    break;
                case 1073:
                    armyMap[4].push_back(it->first);
                    break;
                    
                default:
                    break;
            }
        }
    }
    bool cellFlag = false;
    if (ArmyController::getInstance()->getTotalFree() > 0) {
        cellFlag = true;
    }
    bool st0 = false;
    for (auto it = armyMap.begin(); it != armyMap.end(); ++it) {
        if (it->second.size() > 0)
        {
            if (st0) {
                auto spr = CCLoadSprite::createScale9Sprite("Army_flag_04.png");
                spr->setPreferredSize(CCSize(642, 6));
                spr->setAnchorPoint(ccp(0, 1));
                spr->setPosition(ccp(-1, cury-10));
                if (CCCommonUtils::isIosAndroidPad()) {
                    spr->setPreferredSize(CCSize(1540, 12));
                    spr->setPosition(ccp(-2, cury - 20));
                }
                m_mainNode->addChild(spr);
                cury -= (25 + spr->getPreferredSize().height);
                if (CCCommonUtils::isIosAndroidPad()) {
                    cury -= 25;
                }
            }
            st0 = true;
            for (int i = 0; i < it->second.size(); ++i) {
                auto cell = NewTroopsCell::create(it->second.at(i));
                cell->setPosition((i % cellCnt) * troops_cell_width + 4, cury - floor(i * 1.0 / cellCnt ) * troops_cell_height);
                m_mainNode->addChild(cell);
                if (cellFlag) {
                    cellFlag = false;
                    m_guideNode2 = Node::create();
                    m_guideNode2->setContentSize(Size(troops_cell_width, troops_cell_height));
                    m_guideNode2->setAnchorPoint(ccp(0, 1));
                    m_guideNode2->setPosition(cell->getPosition());
                    m_mainNode->addChild(m_guideNode2);
                }
            }
            cury -= (ceil(it->second.size() * 1.0 / cellCnt)) * troops_cell_height;
        }
    }
    
    if (!st0) {
        cury -= 70;//两大类间隔一定距离
        if (CCCommonUtils::isIosAndroidPad())
        {
            cury -= 70;
        }
    } else {
        cury -= 20;
        if (CCCommonUtils::isIosAndroidPad()) {
            cury -= 20;
        }
    }
    
    //陷阱 title
    auto trapCell = NewTroopsTrapTitle::create();
    trapCell->setPosition(ccp(0, cury));
    m_mainNode->addChild(trapCell);
    if (CCCommonUtils::isIosAndroidPad()) {
        cury -= 160;
    } else {
        cury -= 80;
    }
    
    
    //陷阱 cell
    map< int, vector<string> > traps;
    for (auto it = GlobalData::shared()->fortList.rbegin(); it != GlobalData::shared()->fortList.rend(); ++it)
    {
        if (it->second.free > 0) {
            int tid = atoi((it->first).c_str());
            int level = tid % 10;
            traps[level].push_back(it->first);
        }
    }
    bool st = false;
    for (auto it = traps.rbegin(); it != traps.rend(); ++it) {
        if ((it->second).size() > 0)
        {
            if (st) {
                auto spr = CCLoadSprite::createScale9Sprite("Army_flag_04.png");
                spr->setPreferredSize(CCSize(642, 6));
                spr->setAnchorPoint(ccp(0, 1));
                spr->setPosition(ccp(-1, cury-10));
                if (CCCommonUtils::isIosAndroidPad()) {
                    spr->setPreferredSize(CCSize(1540, 12));
                    spr->setPosition(ccp(-2, cury - 20));
                }
                m_mainNode->addChild(spr);
                cury -= (25 + spr->getPreferredSize().height);
            }
            st = true;
            for (int i = 0; i < it->second.size(); ++i)
            {
                auto cell = NewTroopsCell::create(it->second.at(i));
                cell->setPosition(ccp((i % cellCnt) * troops_cell_width + 4, cury - ((int)(i / cellCnt)) * troops_cell_height));
                m_mainNode->addChild(cell);
            }
            cury -= (ceil(it->second.size() * 1.0 / cellCnt)) * troops_cell_height;
        }
    }
    if (!st) {
        //为了显示没有陷阱的dialog
        if (CCCommonUtils::isIosAndroidPad())
        {
            cury -= 120;
        } else {
            cury -= 60;
        }
    }
    
    //显示出征部队
    if (m_marchInfo.size() > 0) {
        cury -= 20;
        if (CCCommonUtils::isIosAndroidPad()) {
            cury -= 20;
        }
        auto label = CCLabelIF::create();
        label->setString(_lang("103656"));
        label->setColor({72, 60, 44});
        label->setFontSize(22);
        label->setAnchorPoint(Vec2(0.5, 0.5));
        label->setDimensions(Size(0, 0));
        label->setPositionX(320);
        label->setPositionY(cury);
        m_mainNode->addChild(label);
        if (CCCommonUtils::isIosAndroidPad())
        {
            label->setFontSize(44);
            label->setPositionX(768);
        }
        cury -= 20;
        if (CCCommonUtils::isIosAndroidPad()) {
            cury -= 20;
        }
        
        vector<string> vec;
        int allTotalTroop = 0;
        for (auto it = m_marchInfo.begin(); it != m_marchInfo.end(); ++it)
        {
            vec.push_back(it->first);
            allTotalTroop += it->second.totalTroop;
        }
        if (allTotalTroop > 0) {
            string msg = _lang("103656");
            msg += " ";
            msg += CC_CMDITOA(allTotalTroop);
            label->setString(msg);
        }
        //排序
        for (int i = 0; i < vec.size() - 1; ++i)
        {
            for (int j = i + 1; j < vec.size(); ++j)
            {
                string s1 = vec[i];
                string s2 = vec[j];
                if (m_marchInfo[s1].startStamp > m_marchInfo[s2].startStamp) {
                    vec[i] = s2;
                    vec[j] = s1;
                }
            }
        }
        for (int i = 0; i < vec.size(); ++i)
        {
            //出征部队的title
            int totalTroop = m_marchInfo[vec[i]].totalTroop;
            NewTroopsMarchTitle* marchTitle = NewTroopsMarchTitle::create(i, totalTroop, 0, vec[i]);
            marchTitle->setPosition(0, cury);
            m_mainNode->addChild(marchTitle);
            
            //
            cury -= 52;
            if (CCCommonUtils::isIosAndroidPad())
            {
                cury -= 85;
            }
            
            if (!m_bOpen[vec[i]])
            {
                continue;
            }
            marchTitle->setRotate();
            int nowIdx = 0;
            map<string, MarchSoldierDetail> tmpMarchMap;
            for (auto it = m_marchInfo[vec[i]].soldiers.begin(); it != m_marchInfo[vec[i]].soldiers.end(); ++it)
            {
                for (auto it1 = it->second.begin(); it1 != it->second.end(); ++it1)
                {
                    tmpMarchMap[(*it1).armyId] = (*it1);
                }
            }
            armyMap.clear();
            for (auto it = tmpMarchMap.rbegin(); it != tmpMarchMap.rend(); ++it)
            {
                int id = atoi(it->first.c_str());
                int type = id / 100;
                if (it->second.count > 0) {
                    switch (type) {
                        case 1070:
                            armyMap[1].push_back(it->first);
                            break;
                        case 1071:
                            armyMap[2].push_back(it->first);
                            break;
                        case 1072:
                            armyMap[3].push_back(it->first);
                            break;
                        case 1073:
                            armyMap[4].push_back(it->first);
                            break;
                        default:
                            break;
                    }
                }
            }
            vector<string> vec1;
            for (auto it = armyMap.begin(); it != armyMap.end(); ++it) {
                for (auto it1 = it->second.begin(); it1 != it->second.end(); ++it1) {
                    vec1.push_back(*it1);
                }
            }
            for (int i = 0; i < vec1.size(); ++i) {
                float addw = 8;
                if (CCCommonUtils::isIosAndroidPad())
                {
                    addw = 24;
                }
                auto cell = NewTroopsMarchCell::create(vec1.at(i), tmpMarchMap[vec1.at(i)].count);
                cell->setPosition((i % marchCellCnt) * march_cell_width + addw, cury - floor(i * 1.0 / marchCellCnt ) * march_cell_height);
                m_mainNode->addChild(cell);
            }
            cury -= (ceil(vec1.size() * 1.0 / marchCellCnt)) * march_cell_height;
            auto sc9 = CCLoadSprite::createScale9Sprite("Commond7_5_4.png");
            sc9->setAnchorPoint(Vec2(0, 0));
            float www1 = 624;
            float hhh1 = 15;
            if (CCCommonUtils::isIosAndroidPad()) {
                www1 = 1488;
                hhh1 = 30;
            }
            sc9->setPreferredSize(Size(www1, (ceil(vec1.size() * 1.0 / marchCellCnt)) * march_cell_height + hhh1));
            sc9->setContentSize(Size(www1, (ceil(vec1.size() * 1.0 / marchCellCnt)) * march_cell_height + hhh1));
            sc9->setPositionY(cury);
            sc9->setPositionX(8);
            if (CCCommonUtils::isIosAndroidPad())
            {
                sc9->setPositionX(24);
            }
            sc9->setZOrder(-1);
            m_mainNode->addChild(sc9);
            if (CCCommonUtils::isIosAndroidPad())
            {
                cury -= 10;
            }
        }
        
        cury -= 180;
        if (CCCommonUtils::isIosAndroidPad())
        {
            cury -= 300;
        }
    }
    
    
    //上下边界固定不可拖动
    if (abs(cury) < m_listNode->getContentSize().height)
    {
        cury -= (m_listNode->getContentSize().height - abs(cury));
    }
    
    m_scrollView->setContentSize(CCSize(m_listNode->getContentSize().width, abs(cury)));
    m_mainNode->setPosition(0, abs(cury));
    
    float minDy2 = m_scrollView->minContainerOffset().y;
    float addDy = minDy2 - minDy1;
    m_scrollView->setContentOffset(CCPoint(0, dy1 + addDy));

}

void NewTroopsView::scrollViewDidScroll(CCScrollView *view)
{
//    float mindy = m_scrollView->minContainerOffset().y ;
//    float maxdy = m_scrollView->maxContainerOffset().y ;
//    float dy = m_scrollView->getContentOffset().y;
//    if (dy < mindy)
//    {
//        m_scrollView->setContentOffset(ccp(0, mindy));
//    }
//    if (dy > maxdy) {
//        m_scrollView->setContentOffset(ccp(0, maxdy));
//    }
}

bool NewTroopsView::onTouchBegan(cocos2d::CCTouch *pTouch, cocos2d::CCEvent *pEvent)
{
    if (isTouchInside(m_guideNode1, pTouch)) {
        return true;
    }
    if (isTouchInside(m_guideNode2, pTouch)) {
        return true;
    }
    return false;
}

void NewTroopsView::onTouchEnded(cocos2d::CCTouch *pTouch, cocos2d::CCEvent *pEvent)
{
    if (guideKey == "TrainField_1" && m_guideNode1) {
        if(isTouchInside(m_guideNode1, pTouch)) {
            guideKey = "";
            CCSafeNotificationCenter::sharedNotificationCenter()->postNotification(GUIDE_INDEX_CHANGE, CCString::create("TrainField_1"));
            return;
        }
    }
    if (guideKey == "TrainField_2" && m_guideNode2) {
        if(isTouchInside(m_guideNode2, pTouch)) {
            guideKey = "";
            CCSafeNotificationCenter::sharedNotificationCenter()->postNotification(GUIDE_INDEX_CHANGE, CCString::create("TrainField_2"));
            return;
        }
    }
}

void NewTroopsView::onEnter()
{
    CCNode::onEnter();
    setTouchEnabled(true);
//    setSwallowsTouches(false);
    setTitleName(_lang("108724"));
    CCSafeNotificationCenter::sharedNotificationCenter()->addObserver(this, callfuncO_selector(NewTroopsView::onGetMsgMarchData), GET_MARCH_DETAIL_UPDATE_COMMAND, nullptr);
    CCSafeNotificationCenter::sharedNotificationCenter()->addObserver(this, callfuncO_selector(NewTroopsView::onGetMsgMarchTitleTouch), MSG_OUT_TRAP_TITLE_TOUCH, nullptr);
    CCSafeNotificationCenter::sharedNotificationCenter()->addObserver(this, callfuncO_selector(NewTroopsView::refreshView), MSG_TROOP_NUMS_REFRESH, nullptr);
    refreshView(nullptr);
}

void NewTroopsView::onExit()
{
    CCSafeNotificationCenter::sharedNotificationCenter()->removeObserver(this, GET_MARCH_DETAIL_UPDATE_COMMAND);
    CCSafeNotificationCenter::sharedNotificationCenter()->removeObserver(this, MSG_OUT_TRAP_TITLE_TOUCH);
    CCSafeNotificationCenter::sharedNotificationCenter()->removeObserver(this, MSG_TROOP_NUMS_REFRESH);
    CCNode::onExit();
}

void NewTroopsView::onGetMsgMarchData(Ref* ref)
{
    if (!ref) {
        return;
    }
    auto dict = dynamic_cast<__Dictionary*>(ref);
    if (!dict) {
        return;
    }
    MarchDetailInfo t_info;
    t_info.setInfo(dict);
    if (!t_info.uuid.empty())
    {
        m_marchInfo[t_info.uuid] = t_info;
        m_bOpen[t_info.uuid] = false;
    }
    refreshView(nullptr);
}

void NewTroopsView::onGetMsgMarchTitleTouch(Ref* ref)
{
    if (!ref)
    {
        return;
    }
    __String* cs = dynamic_cast<__String*>(ref);
    if (!cs)
    {
        return;
    }
    string uuid = cs->getCString();
    if (uuid.empty())
    {
        return;
    }
    if (m_bOpen.find(uuid) == m_bOpen.end())
    {
        return;
    }
    m_bOpen[uuid] = !m_bOpen[uuid];
    refreshView(nullptr);
}

SEL_CCControlHandler NewTroopsView::onResolveCCBCCControlSelector(cocos2d::CCObject * pTarget, const char * pSelectorName)
{
    return nullptr;
}
bool NewTroopsView::onAssignCCBMemberVariable(cocos2d::CCObject * pTarget, const char * pMemberVariableName, cocos2d::CCNode * pNode)
{
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_listNode", CCNode*, this->m_listNode);
    return false;
}
Node* NewTroopsView::getGuideNode(string _key)
{
    guideKey = _key;
    if ( _key == "TrainField_1" && m_guideNode1 ) {
        return m_guideNode1;
    }
    if ( _key == "TrainField_2" && m_guideNode2) {
        return m_guideNode2;
    }
    return NULL;
}
////////-----------class NewTroopsCell
NewTroopsCell* NewTroopsCell::create(string identity, int cnt)
{
    auto ret = new NewTroopsCell(identity, cnt);
    if (ret && ret->init()) {
        ret->autorelease();
    } else {
        CC_SAFE_DELETE(ret);
    }
    return ret;
}

bool NewTroopsCell::init()
{
    if (!CCNode::init()) {
        return false;
    }
    CCBLoadFile("NewTroopsCell", this, this);
    
    m_iconNode->removeAllChildrenWithCleanup(true);
    m_levelLabel->setColor({160, 177, 200});
    m_numLabel->setColor({160, 177, 200});
    
    
    int id = atoi(m_id.c_str());
    if (id >= 107000 && id <107400)
    {
        if (GlobalData::shared()->armyList.find(m_id) != GlobalData::shared()->armyList.end()) {
            auto& info = GlobalData::shared()->armyList[m_id];
//            auto icon = CCLoadSprite::createSprite((info.getBodyIcon()).c_str());
//            CCCommonUtils::setSpriteMaxSize(icon, 222, true);
//            if (id >= 107300)
//            {
//                CCCommonUtils::setSpriteMaxSize(icon, 200, true);
//            }
            SoldierIconCell* icon = nullptr;
            int star = ArmyController::getInstance()->getStarlvById(m_id);
            if (id >= 107300) {
                icon = SoldierIconCell::create(info.getBodyIcon().c_str(), 190,m_id,true,star,m_iconGrey);
            }else{
                icon = SoldierIconCell::create(info.getBodyIcon().c_str(), 200,m_id,true,star,m_iconGrey);
            }
            m_iconNode->addChild(icon);
            m_numLabel->setString(CC_CMDITOA(info.free));
            m_levelLabel->setString(troops_roman[info.armyLevel]);
        }
    } else {
        if (GlobalData::shared()->fortList.find(m_id) != GlobalData::shared()->fortList.end()) {
            auto& info = GlobalData::shared()->fortList[m_id];
            auto icon = CCLoadSprite::createSprite((info.getBodyIcon()).c_str());
            CCCommonUtils::setSpriteMaxSize(icon, 170, true);
            m_iconNode->addChild(icon);
            m_numLabel->setString(CC_CMDITOA(info.free));
            int level = id % 10;
            m_levelLabel->setString(troops_roman[level]);
        }
    }
    float w = m_numLabel->getContentSize().width * m_numLabel->getOriginScaleX();
    float curscale = m_numLabel->getScale();
    float maxw = 100.0;
    if (CCCommonUtils::isIosAndroidPad()) {
        maxw = 200.0;
    }
    if (w > maxw) {
        float scale = maxw / w * curscale;
        m_numLabel->setScale(scale);
    }
    
    return true;
}

void NewTroopsCell::onEnter()
{
    CCNode::onEnter();
    setSwallowsTouches(false);
    setTouchMode(Touch::DispatchMode::ONE_BY_ONE);
    setTouchEnabled(true);
}

void NewTroopsCell::onExit()
{
    CCNode::onExit();
}

bool NewTroopsCell::onAssignCCBMemberVariable(cocos2d::CCObject * pTarget, const char * pMemberVariableName, cocos2d::CCNode * pNode)
{
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_touchNode", CCNode*, this->m_touchNode);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_iconNode", CCNode*, this->m_iconNode);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_numLabel", CCLabelIF*, this->m_numLabel);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_levelLabel", CCLabelIF*, this->m_levelLabel);
    return false;
}

bool NewTroopsCell::onTouchBegan(cocos2d::CCTouch *pTouch, cocos2d::CCEvent *pEvent){
    if (isTouchInside(m_touchNode, pTouch) && guideKey == "") {
        return true;
    }
    return false;
}
void NewTroopsCell::onTouchEnded(cocos2d::CCTouch *pTouch, cocos2d::CCEvent *pEvent){
    float dis = ccpDistance(pTouch->getStartLocation(), pTouch->getLocation());
    if (dis > 10) {
        return;
    }
     if(isTouchInside(m_touchNode, pTouch)) {
         auto m_info = &GlobalData::shared()->armyList[m_id];
         if (m_info) {
             string buildId =m_info->getBuildId();
             if (buildId != "") {
                 int buildingId = std::atoi(buildId.c_str());
                 auto dictInfo = LocalController::shared()->DBXMLManager()->getObjectByKey(CC_ITOA(buildingId));
                 auto tmpBuild = FunBuildInfo(dictInfo);
                 string open_arms = tmpBuild.open_arms;
                 if(open_arms != ""){
                     int bid = FunBuildController::getInstance()->getMaxLvBuildByType( buildingId );
                     vector<string> m_armyIds = ArmyController::getInstance()->getCreateSoldierIds(open_arms, false);
                     auto view = SoldierMoreInfoView::create(m_info,bid,m_armyIds);
                     if (view) {
                         view->setCleanFunction([](){
                             CCLoadSprite::doResourceByCommonIndex(502, false);
                             CCLoadSprite::doResourceByCommonIndex(510, false);
                             CCLoadSprite::doResourceByCommonIndex(4, false);
                         });
                     }
                     PopupViewController::getInstance()->addPopupView(view);
                     return;
                 }
             }
         }
    }
}

//////------------class NewTroopsBtn
bool NewTroopsBtn::init()
{
    CCNode::init();
    CCBLoadFile("NewTroopsBtn", this, this);
    //判断是否有编队功能按钮:15本两个,SVIP根据等级取值
    int formationCount = 0;
    if (FunBuildController::getInstance()->getMainCityLv() >= 15) {
        formationCount += 2;
    }
    auto &playerInfo = GlobalData::shared()->playerInfo;
    int svipLv = playerInfo.SVIPLevel;
    if(VipUtil::isSVIP() && svipLv > 0 && playerInfo.vipEndTime > GlobalData::shared()->getWorldTime()) {
        int itemID = 7010+svipLv-1;
        int value = atoi(CCCommonUtils::getPropById(CC_ITOA(itemID), "troop").c_str());
        if (value > 0) {
            formationCount += value;
        }
    }
    vector<CCSafeObject<Node>> formationVec;
    formationVec.clear();
    formationVec.push_back(m_formation1);
    formationVec.push_back(m_formation2);
    formationVec.push_back(m_formation3);
    formationVec.push_back(m_formation4);
    formationVec.push_back(m_formation5);
    if (formationCount > 0 && GlobalData::shared()->march_formation_switch == 2) {
        m_formationNode->setVisible(true);
        m_formation1->setVisible(false);
        m_formation2->setVisible(false);
        m_formation3->setVisible(false);
        m_formation4->setVisible(false);
        m_formation5->setVisible(false);
        for(int i = 0; i < formationCount; i++) {
            formationVec[i]->setVisible(true);
            formationVec[i]->setPositionX((i - formationCount + 1) * 60);
        }
    }
    else {
        m_formationNode->setVisible(false);
    }
    return true;
}

void NewTroopsBtn::onFormation1Click(CCObject *pSender, CCControlEvent event)
{
    auto view = MarchFormationView::create(1);
    if (view) {
        view->setCleanFunction([](){
            CCLoadSprite::doResourceByCommonIndex(8, false);
        });
    }
    PopupViewController::getInstance()->addPopupInView(view);
}

void NewTroopsBtn::onFormation2Click(CCObject *pSender, CCControlEvent event)
{
    auto view = MarchFormationView::create(2);
    if (view)
    {
        view->setCleanFunction([](){
            CCLoadSprite::doResourceByCommonIndex(8, false);
        });
    }
    PopupViewController::getInstance()->addPopupInView(view);
}

void NewTroopsBtn::onFormation3Click(CCObject *pSender, CCControlEvent event)
{
    auto view = MarchFormationView::create(3);
    if (view)
    {
        view->setCleanFunction([](){
            CCLoadSprite::doResourceByCommonIndex(8, false);
        });
    }
    PopupViewController::getInstance()->addPopupInView(view);
}

void NewTroopsBtn::onFormation4Click(CCObject *pSender, CCControlEvent event)
{
    auto view = MarchFormationView::create(4);
    if (view)
    {
        view->setCleanFunction([](){
            CCLoadSprite::doResourceByCommonIndex(8, false);
        });
    }
    PopupViewController::getInstance()->addPopupInView(view);
}

void NewTroopsBtn::onFormation5Click(CCObject *pSender, CCControlEvent event)
{
    auto view = MarchFormationView::create(5);
    if (view)
    {
        view->setCleanFunction([](){
            CCLoadSprite::doResourceByCommonIndex(8, false);
        });
    }
    PopupViewController::getInstance()->addPopupInView(view);
}

SEL_CCControlHandler NewTroopsBtn::onResolveCCBCCControlSelector(cocos2d::CCObject * pTarget, const char * pSelectorName)
{
    CCB_SELECTORRESOLVER_CCCONTROL_GLUE(this, "onFormation1Click", NewTroopsBtn::onFormation1Click);
    CCB_SELECTORRESOLVER_CCCONTROL_GLUE(this, "onFormation2Click", NewTroopsBtn::onFormation2Click);
    CCB_SELECTORRESOLVER_CCCONTROL_GLUE(this, "onFormation3Click", NewTroopsBtn::onFormation3Click);
    CCB_SELECTORRESOLVER_CCCONTROL_GLUE(this, "onFormation4Click", NewTroopsBtn::onFormation4Click);
    CCB_SELECTORRESOLVER_CCCONTROL_GLUE(this, "onFormation5Click", NewTroopsBtn::onFormation5Click);
    return nullptr;
}

bool NewTroopsBtn::onAssignCCBMemberVariable(cocos2d::CCObject * pTarget, const char * pMemberVariableName, cocos2d::CCNode * pNode)
{
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_formationNode", Node*, m_formationNode);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_formation5", Node*, m_formation5);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_formation4", Node*, m_formation4);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_formation3", Node*, m_formation3);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_formation2", Node*, m_formation2);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_formation1", Node*, m_formation1);
    return false;
}


/////------------class NewTroopsArmyTitle
NewTroopsArmyTitle* NewTroopsArmyTitle::create()
{
    auto ret = new NewTroopsArmyTitle();
    if (ret && ret->init())
    {
        ret->autorelease();
    } else {
        CC_SAFE_DELETE(ret);
    }
    return ret;
}

bool NewTroopsArmyTitle::init()
{
    CCNode::init();
    CCBLoadFile("NewTroopsArmyTitle", this, this);
    
    float dw = 10;
    if (CCCommonUtils::isIosAndroidPad()) {
        dw = 20;
    }
    m_armyLabel->setString(_lang("102149"));
    m_armyLabel->setColor({127, 127, 127});
    m_armyNum->setString(CC_CMDITOA(ArmyController::getInstance()->getTotalArmyMan()));
    m_armyNum->setPositionX(m_armyLabel->getPositionX() + m_armyLabel->getContentSize().width * m_armyLabel->getOriginScaleX() + dw);
    m_armyNum->setColor({160, 177, 202});
    
    m_marchLabel->setString(_lang("102141"));
    int maxMarchNum = WorldController::getInstance()->getMaxMarchCount();
    int nowMarchNum = maxMarchNum - WorldController::getInstance()->getCurrentMarchCount();
    nowMarchNum = max(0, nowMarchNum);
    string msg = CC_ITOA(nowMarchNum);
    msg += "/";
    msg += CC_ITOA(maxMarchNum);
    m_marchNum->setString(msg);
    m_marchNum->setPositionX(m_marchLabel->getPositionX() + m_marchLabel->getContentSize().width * m_marchLabel->getOriginScaleX() + dw);
    m_marchLabel->setColor({127, 127, 127});
    m_marchNum->setColor({127, 127, 127});
    
    m_foodSpdLabel->setString(_lang("102125"));
    int upKeep = ArmyController::getInstance()->getTotalUpKeep();
    msg = CC_CMDITOA(upKeep);
    msg += "/h";
    m_foodSpd->setString(msg);
    m_foodSpd->setPositionX(m_foodSpdLabel->getPositionX() + m_foodSpdLabel->getContentSize().width * m_foodSpdLabel->getOriginScaleX() + dw);
    m_foodSpdLabel->setColor({127, 127, 127});
    m_foodSpd->setColor({127, 127, 127});
    
    m_woundedLabel->setString(_lang("102186"));
    int deadNum = 0;
    for(auto Tit = GlobalData::shared()->treatList.begin(); Tit != GlobalData::shared()->treatList.end(); Tit++){
        deadNum += Tit->second.dead;
    }
    msg = CC_CMDITOA(deadNum) + "/" + CC_CMDITOA(ArmyController::getInstance()->getMaxNumByType(TREAT_ARMY));
    m_woundedNum->setString(msg);
    m_woundedNum->setPositionX(m_woundedLabel->getPositionX() + m_woundedLabel->getContentSize().width * m_woundedLabel->getOriginScaleX() + dw);
    m_woundedLabel->setColor({127, 127, 127});
    m_woundedNum->setColor({127, 127, 127});
    
    if (ArmyController::getInstance()->getTotalFree() > 0)
    {
        string ms = _lang("103694");
        ms += " ";
        ms += CC_CMDITOA(ArmyController::getInstance()->getTotalFree());
        m_myTroopLabel->setString(ms);
    } else {
        m_myTroopLabel->setString(_lang("103695"));
    }
    
    m_myTroopLabel->setColor({72, 60, 44});
    
    
    return true;
}

SEL_CCControlHandler NewTroopsArmyTitle::onResolveCCBCCControlSelector(cocos2d::CCObject * pTarget, const char * pSelectorName)
{
    return nullptr;
}

bool NewTroopsArmyTitle::onAssignCCBMemberVariable(cocos2d::CCObject * pTarget, const char * pMemberVariableName, cocos2d::CCNode * pNode)
{
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_armyLabel", CCLabelIF*, this->m_armyLabel);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_armyNum", CCLabelIF*, this->m_armyNum);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_marchLabel", CCLabelIF*, this->m_marchLabel);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_marchNum", CCLabelIF*, this->m_marchNum);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_woundedLabel", CCLabelIF*, this->m_woundedLabel);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_woundedNum", CCLabelIF*, this->m_woundedNum);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_foodSpdLabel", CCLabelIF*, this->m_foodSpdLabel);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_foodSpd", CCLabelIF*, this->m_foodSpd);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_myTroopLabel", CCLabelIF*, this->m_myTroopLabel);
    return false;
}

/////-----------class NewTroopsTrapTitle
NewTroopsTrapTitle* NewTroopsTrapTitle::create()
{
    auto ret = new NewTroopsTrapTitle();
    if (ret && ret->init())
    {
        ret->autorelease();
    } else {
        CC_SAFE_DELETE(ret);
    }
    return ret;
}

bool NewTroopsTrapTitle::init()
{
    CCNode::init();
    CCBLoadFile("NewTroopsTrapTitle", this, this);
    m_trapLabel->setString(_lang("102185"));
    string msg = CC_CMDITOA(ArmyController::getInstance()->getTotalFortNum()) +"/"+ CC_CMDITOA( ArmyController::getInstance()->getMaxNumByType(FORT));
    m_trapNum->setString(msg);
    float dw = 10;
    if (CCCommonUtils::isIosAndroidPad()) {
        dw = 20;
    }
    m_trapNum->setPositionX(m_trapLabel->getPositionX() + m_trapLabel->getContentSize().width * m_trapLabel->getOriginScaleX() + dw);
    m_trapLabel->setColor({127, 127, 127});
    m_trapNum->setColor({127, 127, 127});
    m_tipLabel->setColor({72, 60, 44});
    if (ArmyController::getInstance()->getTotalFortNum() <= 0)
    {
        m_tipLabel->setString(_lang("103696"));
    } else {
        m_tipLabel->setString("");
    }
    return true;
}

bool NewTroopsTrapTitle::onAssignCCBMemberVariable(cocos2d::CCObject * pTarget, const char * pMemberVariableName, cocos2d::CCNode * pNode)
{
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_tipLabel", CCLabelIF*, this->m_tipLabel);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_trapLabel", CCLabelIF*, this->m_trapLabel);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_trapNum", CCLabelIF*, this->m_trapNum);
    return false;
}

/////--------class NewTroopsMarchTitle------
bool NewTroopsMarchTitle::init()
{
    CCBLoadFile("NewTroopsMarchTitle", this, this, true);
    m_trapLabel->setColor({127, 127, 127});
    m_trapNum->setColor({127, 127, 127});
    m_trapLabel->setString(_lang_1("103657", CC_ITOA(m_idx + 1)));
    m_trapNum->setString(CC_CMDITOA(m_num));
    m_stateLabel->setString("");
    int queueType = -1;
    for (auto it = GlobalData::shared()->allQueuesInfo.begin(); it != GlobalData::shared()->allQueuesInfo.end(); ++it) {
        if (it->second.uuid == m_marchUid)
        {
            queueType = it->second.type;
            break;
        }
    }
    string temp("");
    switch (queueType) {
        case TYPE_MARCH:
            temp = _lang("115351");
            break;
            
        case TYPE_OCCUPY_RESOURCE:
            temp = _lang("108735");
            break;
            
        case TYPE_OCCUPY_MAZE:
            temp = _lang("108736");
            break;
            
        case TYPE_OCCUPY_CAMP:
            temp = _lang("108737");
            break;
            
        case TYPE_ARMY_MASS:
            temp = _lang("115136");
            break;
            
        case TYPE_OCCUPY_ALLIANCE:
        case TYPE_STATION_TERRITORY:
            temp = _lang("115346");
            break;
            
        case TYPE_DESTROY_TERRITORY:
            temp = _lang("115347");
            break;
            
        case TYPE_BUILDING_TERRITORY:
            temp = _lang("115305");
            break;
            
        case TYPE_REPAIR_TERRITORY:
            temp = _lang("115305");
            break;
            
        case TYPE_OCCUPY_TERRITORY_RESOURCE://采集超级矿
            temp = _lang("108735");
            break;
            
        default:
            temp = _lang("115351");
            break;
    }
    // 注释掉 不显示部队状态信息
//    m_stateLabel->setString(temp);
    return true;
}

void NewTroopsMarchTitle::onEnter()
{
    Node::onEnter();
    setTouchEnabled(true);
    setSwallowsTouches(false);
}

void NewTroopsMarchTitle::onExit()
{
    Node::onExit();
}

bool NewTroopsMarchTitle::onTouchBegan(Touch *pTouch, Event *pEvent)
{
    if (isTouchInside(m_touchNode, pTouch)) {
        return true;
    }
    return false;
}

void NewTroopsMarchTitle::onTouchEnded(Touch *pTouch, Event *pEvent)
{
    float dis = ccpDistance(pTouch->getStartLocation(), pTouch->getLocation());
    if (dis > 10) {
        return;
    }
    retain();
    CCSafeNotificationCenter::sharedNotificationCenter()->postNotification(MSG_OUT_TRAP_TITLE_TOUCH, __String::create(m_marchUid));
    release();
}

bool NewTroopsMarchTitle::onAssignCCBMemberVariable(cocos2d::CCObject * pTarget, const char * pMemberVariableName, cocos2d::CCNode * pNode)
{
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_trapLabel", CCLabelIF*, m_trapLabel);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_trapNum", CCLabelIF*, m_trapNum);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_stateLabel", CCLabelIF*, m_stateLabel);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_touchNode", Node*, m_touchNode);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_arrow", Sprite*, m_arrow);
    return false;
}

void NewTroopsMarchTitle::setRotate()
{
    m_arrow->setRotation(90);
}

//---------class NewTroopsMarchCell----
bool NewTroopsMarchCell::init()
{
    CCLoadSprite::doResourceByCommonIndex(204, true);
    CCBLoadFile("NewTroopsMarchCell", this, this);
    m_iconNode->removeAllChildren();
    auto& info = GlobalData::shared()->armyList[m_armyId];
    auto icon = CCLoadSprite::createSprite(info.getHeadIcon().c_str());
    m_iconNode->addChild(icon);
    m_numLabel->setColor({160, 177, 200});
    m_numLabel->setString(CC_CMDITOA(m_num));
    m_levelLabel->setColor({160, 177, 200});
    m_levelLabel->setString(troops_roman[info.armyLevel]);
    return true;
}

bool NewTroopsMarchCell::onAssignCCBMemberVariable(cocos2d::CCObject * pTarget, const char * pMemberVariableName, cocos2d::CCNode * pNode)
{
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_iconNode", Node*, m_iconNode);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_numLabel", CCLabelIF*, m_numLabel);
    CCB_MEMBERVARIABLEASSIGNER_GLUE_WEAK(this, "m_levelLabel", CCLabelIF*, m_levelLabel);
    return false;
}

